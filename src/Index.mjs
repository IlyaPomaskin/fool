// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Base from "./components/Base.mjs";
import * as Jzon from "rescript-jzon/src/Jzon.mjs";
import * as Curry from "rescript/lib/es6/curry.js";
import * as Utils from "./Utils.mjs";
import * as React from "react";
import * as GameUI from "./components/GameUI.mjs";
import * as ClientUI from "./components/ClientUI.mjs";
import * as PlayerUI from "./components/PlayerUI.mjs";
import * as Belt_List from "rescript/lib/es6/belt_List.js";
import * as Serializer from "./Serializer.mjs";
import * as Belt_Option from "rescript/lib/es6/belt_Option.js";
import * as Webapi__WebSocket from "rescript-webapi/src/Webapi/Webapi__WebSocket.mjs";

function Index$Client(Props) {
  var playerId = Props.playerId;
  var ws = React.useMemo((function () {
          return new WebSocket("ws://localhost:3001/ws");
        }), []);
  var match = React.useState(function () {
        
      });
  var setPlayer = match[1];
  var player = match[0];
  var match$1 = React.useState(function () {
        
      });
  var setInLobby = match$1[1];
  var inLobby = match$1[0];
  var match$2 = React.useState(function () {
        
      });
  var setInProgress = match$2[1];
  var inProgress = match$2[0];
  var match$3 = React.useState(function () {
        
      });
  var setError = match$3[1];
  var error = match$3[0];
  React.useEffect((function () {
          console.log("CREATE SOCKET");
          ws.addEventListener("open", (function (param) {
                  console.log("open", playerId);
                  ws.send(Serializer.serializeClientMessage({
                            TAG: /* Player */0,
                            _0: /* Connect */0,
                            _1: playerId
                          }));
                  
                }));
          ws.addEventListener("message", (function ($$event) {
                  var msg = Webapi__WebSocket.messageAsText($$event);
                  var msg$1 = msg !== undefined ? Serializer.deserializeServerMessage(msg) : ({
                        TAG: /* Error */1,
                        _0: {
                          NAME: "SyntaxError",
                          VAL: "Message can't be parsed as json"
                        }
                      });
                  console.log("unbox", msg$1);
                  var tmp;
                  if (msg$1.TAG === /* Ok */0) {
                    var player = msg$1._0;
                    switch (player.TAG | 0) {
                      case /* Connected */0 :
                          tmp = "Connected: " + playerId + " " + Belt_Option.getWithDefault(player._0.sessionId, "no sesid");
                          break;
                      case /* LobbyCreated */1 :
                          tmp = "LobbyCreated: " + playerId + " " + player._0.gameId;
                          break;
                      case /* LobbyUpdated */2 :
                          tmp = "LobbyUpdated: " + playerId + " " + player._0.gameId;
                          break;
                      case /* ProgressCreated */3 :
                          tmp = "ProgressCreated: " + playerId + " " + player._0.gameId;
                          break;
                      case /* ProgressUpdated */4 :
                          tmp = "ProgressUpdated: " + playerId + " " + player._0.gameId;
                          break;
                      case /* Err */5 :
                          tmp = "Error: " + playerId + " " + player._0;
                          break;
                      
                    }
                  } else {
                    tmp = "unk";
                  }
                  console.log("msg:", tmp);
                  if (msg$1.TAG === /* Ok */0) {
                    var gMsg = msg$1._0;
                    var exit = 0;
                    switch (gMsg.TAG | 0) {
                      case /* Connected */0 :
                          var player$1 = gMsg._0;
                          return Curry._1(setPlayer, (function (param) {
                                        return player$1;
                                      }));
                      case /* LobbyCreated */1 :
                      case /* LobbyUpdated */2 :
                          exit = 1;
                          break;
                      case /* ProgressCreated */3 :
                      case /* ProgressUpdated */4 :
                          exit = 2;
                          break;
                      case /* Err */5 :
                          var msg$2 = gMsg._0;
                          console.log("msg event", msg$2);
                          return Curry._1(setError, (function (param) {
                                        return msg$2;
                                      }));
                      
                    }
                    switch (exit) {
                      case 1 :
                          var inLobby = gMsg._0;
                          return Curry._1(setInLobby, (function (param) {
                                        return inLobby;
                                      }));
                      case 2 :
                          var inProgress = gMsg._0;
                          return Curry._1(setInProgress, (function (param) {
                                        return inProgress;
                                      }));
                      
                    }
                  } else {
                    console.log("received msg error: " + Jzon.DecodingError.toString(msg$1._0));
                    return ;
                  }
                }));
          ws.addEventListener("close", (function (param) {
                  console.log("close", playerId);
                  ws.send(Serializer.serializeClientMessage({
                            TAG: /* Player */0,
                            _0: /* Disconnect */1,
                            _1: playerId
                          }));
                  
                }));
          ws.addEventListener("error", (function ($$event) {
                  console.log("error", playerId, $$event);
                  
                }));
          return (function (param) {
                    ws.close();
                    
                  });
        }), []);
  var handleMove = function (move) {
    if (inProgress !== undefined) {
      ws.send(Serializer.serializeClientMessage({
                TAG: /* Progress */2,
                _0: move,
                _1: playerId,
                _2: inProgress.gameId
              }));
      return Curry._1(setError, (function (param) {
                    
                  }));
    }
    
  };
  return React.createElement("div", undefined, React.createElement("div", undefined, React.createElement(Base.Button.make, {
                      onClick: (function (param) {
                          ws.send(Serializer.serializeClientMessage({
                                    TAG: /* Player */0,
                                    _0: /* Connect */0,
                                    _1: playerId
                                  }));
                          
                        }),
                      children: Utils.uiStr("create player")
                    }), React.createElement(Base.Button.make, {
                      onClick: (function (param) {
                          ws.send(Serializer.serializeClientMessage({
                                    TAG: /* Lobby */1,
                                    _0: /* Create */0,
                                    _1: playerId,
                                    _2: ""
                                  }));
                          
                        }),
                      children: Utils.uiStr("create lobby")
                    }), React.createElement(Base.Button.make, {
                      onClick: (function (param) {
                          ws.send(Serializer.serializeClientMessage({
                                    TAG: /* Lobby */1,
                                    _0: /* Enter */1,
                                    _1: playerId,
                                    _2: "gameId"
                                  }));
                          
                        }),
                      children: Utils.uiStr("lobby connect")
                    }), inLobby !== undefined ? React.createElement("div", undefined, React.createElement(Base.Button.make, {
                            pressed: Belt_List.has(Belt_List.map(inLobby.ready, (function (a) {
                                        return a;
                                      })), player, Utils.equals),
                            onClick: (function (param) {
                                ws.send(Serializer.serializeClientMessage({
                                          TAG: /* Lobby */1,
                                          _0: /* Ready */2,
                                          _1: playerId,
                                          _2: inLobby.gameId
                                        }));
                                
                              }),
                            children: Utils.uiStr("lobby ready")
                          }), React.createElement(Base.Button.make, {
                            onClick: (function (param) {
                                ws.send(Serializer.serializeClientMessage({
                                          TAG: /* Lobby */1,
                                          _0: /* Start */3,
                                          _1: playerId,
                                          _2: inLobby.gameId
                                        }));
                                
                              }),
                            children: Utils.uiStr("lobby start")
                          })) : null), React.createElement("div", undefined, error !== undefined ? React.createElement("div", undefined, Utils.uiStr("server error: " + error)) : React.createElement("div", undefined, Utils.uiStr("no server error"))), React.createElement("div", undefined, player !== undefined ? React.createElement(PlayerUI.Short.make, {
                        player: player
                      }) : React.createElement("div", undefined)), inLobby !== undefined ? React.createElement("div", undefined, Utils.uiStr("inLobby")) : React.createElement("div", undefined), inProgress !== undefined ? React.createElement("div", undefined, React.createElement(GameUI.InProgressUI.make, {
                        game: inProgress
                      }), React.createElement("div", {
                        className: "flex flex-wrap"
                      }, Utils.uiList(inProgress.players, (function (player) {
                              return React.createElement(ClientUI.make, {
                                          className: "m-1 flex-initial w-96",
                                          player: player,
                                          isOwner: player.id === playerId,
                                          game: inProgress,
                                          onMove: handleMove,
                                          key: player.id
                                        });
                            }))), React.createElement("div", undefined, Utils.uiStr(Belt_Option.getWithDefault(Belt_Option.map(error, (function (err) {
                                      return "Error: " + err;
                                    })), "No errors")))) : React.createElement("div", undefined));
}

function $$default(param) {
  return React.createElement("div", undefined, React.createElement("div", {
                  className: "my-2 w-1/2 inline-block border rounded-md border-solid border-slate-500"
                }, React.createElement(Index$Client, {
                      playerId: "alice"
                    })), React.createElement("div", {
                  className: "my-2 w-1/2 inline-block border rounded-md border-solid border-slate-500"
                }, React.createElement(Index$Client, {
                      playerId: "bob"
                    })));
}

export {
  $$default ,
  $$default as default,
  
}
/* Base Not a pure module */
